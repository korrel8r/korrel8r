name: Publish Documentation

on:
  schedule:
    - cron: '0 5 * * *'  # Run daily at midnight EST (5 AM UTC)
  workflow_dispatch:  # Allow manual triggers

jobs:
  docs:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent runaway jobs
    permissions:
      contents: read  # Explicit permissions for security
    outputs:
      should-deploy: ${{ steps.git.outputs.changes != '0' }}
    steps:
      - uses: actions/checkout@v4
        with:
          # Get full history for reliable git operations
          fetch-depth: 0
          fetch-tags: true

      - name: Check for changes
        id: status
        run: |
          CHANGES="$(git log --since='24 hours ago' --oneline | wc -l)"
          echo "changes=$CHANGES" >> $GITHUB_OUTPUT
          [[ "$CHANGES" == '0' ]] && echo "::notice::No changes in the last 24 hours, skipping build"

      - uses: actions/setup-go@v5
        if: steps.status.outputs.changes != '0'
        with:
          go-version: "1.25"

      - uses: actions/cache@v4
        if: steps.status.outputs.changes != '0'
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Generate Web Site
        if: steps.status.outputs.changes != '0'
        run: make _site

      - name: Upload web site
        if: steps.status.outputs.changes != '0'
        uses: actions/upload-pages-artifact@v3

  deploy:
    needs: docs
    if: needs.docs.outputs.should-deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Pages deployment should be quick

    permissions:            # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
      pages: write          # to deploy to Pages
      id-token: write       # to verify the deployment originates from an appropriate source

    environment:            # Deploy to the github-pages environment
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
